#  Kafka 消费者

## 消费方式

consumer 采用 pull（拉）模式从 broker 中读取数据。 push（推）模式很难适应消费速率不同的消费者，因为消息发送速率是由 broker 决定的。 它的目标是尽可能以最快速度传递消息，但是这样很容易造成 consumer 来不及处理消息，典型的表现就是拒绝服务以及网络拥塞。而 pull 模式则可以根据 consumer 的消费能力以适 当的速率消费消息。

pull 模式不足之处是，如果 kafka 没有数据，消费者可能会陷入循环中，一直返回空数 据。针对这一点，**Kafka 的消费者在消费数据时会传入一个时长参数 timeout，如果当前没有 数据可供消费，consumer 会等待一段时间之后再返回，这段时长即为 timeout。**

## 分区分配策略

1. RoundRobin

一个消费者组有多个消费者，会把一个消费者组里的所有消费者指定的全部主题拿出来，再统一按分区分配给该组里面的所有消费者进行消费（按照主题名+分区号排序，轮询分配给组里的所有消费者）。。也就是说，轮询策略下，消费者组中的消费者无法特别指定自身要消费的主题。自己指定的主题会被拿出去到整个组中统一分配。自己也会消费到自己没有指定的主题(不过该主题肯定是由同组的其他消费者指定的)

假设消费者组G有AB两个消费者，

有T1 、T2  两个主题，每个主题都有三个分区，分区好分别是0,1,2。

其中A指定要消费T1 主题，而B指定要消费T2主题。由于A和B属于同一个消费者组G，那么G这个组就会消费AUB（A与B的并集）={T1,T2}，共两个主题，六个分区。

（1）也就是说，RoundRobin会让消费者组G的所有成员(A和B)一起轮询消费这六个分区(T1-0,T1-1,T1-2,T2-0,T2-1,T2-2)。

kafka会把六个分区按照主题名+分区号作为hash值进行排序，假设排序完是T1-0,T1-1,T1-2,T2-0,T2-1,T2-2共六个。

然后按照轮询分配。。。A分配T1-0    B分配T1-1     A分配T1-2  B分配T2-0 ......

最终：A分配了T1-0  T1-2    T2-1 三个分区。B则分配了剩下的三个分区。

- 缺点

**这样就会导致A可能会消费到T2主题的分区，B也可能会消费到T1主题的分区。而A并没有指定要消费T2分区，B也没有指定要消费T1分区。。这算是一种缺点。。消费到同组的其他消费者所指定的主题分区数据。**

- 适用范围、
  - **在同一个消费者组中的所有消费者各自指定要消费的主题都是一样的情况下**，即消费者组里面想要消费的主题都相同

2. range

会按照主题来进行分配。一个主题的分区分配完了，再继续分配下一个主题。

**分配规则**：同一个消费者组有哪些成员指定了相同的主题，则由这些成员去消费该主题的分区。其他未指定该主题的成员不会消费到这个主题。

具体举个例子(如果根据上面的描述就懂了，可以跳过该例子)：

假设有主题T1和T2和T3，各自三个分区(0，1,2)。

消费者组G，有两个消费者A和B。

其中A指定要消费T1和T2，B要消费T2和T3.

那么按照每个主题，一个主题一个主题分配给A和B进行消费。

即假设按照T1  T2  T3的顺序来。

（1）先分配主题T1，由于T1只有A消费，那么就直接T1-0，T1-1，T1-2都分配给A消费了。

（2）然后分配主题T2，T2有A和B一起消费，A和B属于同一个消费者组，是Range策略。。。

那么T2-0，T2-1，T2-2三个分区中，会按照轮询规则把三个分区分配给A和B两个消费者。A可能分配到两个分区，B可能分配到1额分区。

（3）最后分配T3主题，由于只有B消费，所有T3全部分区都分配给B消费。



**缺点，就是当同一个消费者组的多个消费者消费的主题相同，并且消费的相同主题比较多时，按照上面步骤(2)的情况，可能会导致消费者A消费十个分区，而消费者B只消费了五个分区，这样不平衡。**

但好处在于，同一个消费者组的不同消费者可以指定自己单独需要消费的主题。。只有当其他消费者与当前消费者指定的主题相同时，才会一起分配这个主题的不同分区。


